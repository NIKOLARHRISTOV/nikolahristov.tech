import{e as P}from"./index.modern.kBZUKyzZ.js";import{getCurrentUrl as k,Location as w}from"./Swup.modern.uAVexcQX.js";function v(){return v=Object.assign?Object.assign.bind():function(c){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(c[s]=r[s])}return c},v.apply(this,arguments)}function y(){return window.matchMedia("(hover: hover)").matches}const L=window.requestIdleCallback||(c=>setTimeout(c,1)),O=["preloadVisibleLinks"];class T extends P{constructor(e={}){var r;super(),r=this,this.name="SwupPreloadPlugin",this.requires={swup:">=4.5"},this.defaults={throttle:5,preloadInitialPage:!0,preloadHoveredLinks:!0,preloadVisibleLinks:{enabled:!1,threshold:.2,delay:500,containers:["body"],ignore:()=>!1}},this.options=void 0,this.queue=void 0,this.preloadObserver=void 0,this.preloadPromises=new Map,this.mouseEnterDelegate=void 0,this.touchStartDelegate=void 0,this.focusDelegate=void 0,this.onPageLoad=(t,i,d)=>{const{url:n}=t.to;return n&&this.preloadPromises.has(n)?this.preloadPromises.get(n):d(t,i)},this.onMouseEnter=async function(t){if(t.target!==t.delegateTarget||!y())return;const i=t.delegateTarget;i instanceof HTMLAnchorElement&&(r.swup.hooks.callSync("link:hover",void 0,{el:i,event:t}),r.preload(i,{priority:!0}))},this.onTouchStart=t=>{if(y())return;const i=t.delegateTarget;i instanceof HTMLAnchorElement&&this.preload(i,{priority:!0})},this.onFocus=t=>{const i=t.delegateTarget;i instanceof HTMLAnchorElement&&this.preload(i,{priority:!0})};const{preloadVisibleLinks:s}=e,o=function(t,i){if(t==null)return{};var d,n,h={},p=Object.keys(t);for(n=0;n<p.length;n++)i.indexOf(d=p[n])>=0||(h[d]=t[d]);return h}(e,O);this.options=v({},this.defaults,o),typeof s=="object"?this.options.preloadVisibleLinks=v({},this.options.preloadVisibleLinks,{enabled:!0},s):this.options.preloadVisibleLinks.enabled=!!s,this.preload=this.preload.bind(this),this.queue=function(t=1){const i=[],d=[];let n=0,h=0;function p(){h<t&&n>0&&((d.shift()||i.shift()||(()=>{}))(),n--,h++)}return{add:function(u,g=!1){if(u.__queued){if(!g)return;{const f=i.indexOf(u);if(f>=0){const a=i.splice(f,1);n-=a.length}}}u.__queued=!0,(g?d:i).push(u),n++,n<=1&&p()},next:function(){h--,p()}}}(this.options.throttle)}mount(){const e=this.swup;e.options.cache?(e.hooks.create("page:preload"),e.hooks.create("link:hover"),e.preload=this.preload,e.preloadLinks=this.preloadLinks,this.replace("page:load",this.onPageLoad),this.preloadLinks(),this.on("page:view",()=>this.preloadLinks()),this.options.preloadVisibleLinks.enabled&&(this.preloadVisibleLinks(),this.on("page:view",()=>this.preloadVisibleLinks())),this.options.preloadHoveredLinks&&this.preloadLinksOnAttention(),this.options.preloadInitialPage&&this.preload(k())):console.warn("SwupPreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){var e,r,s;this.swup.preload=void 0,this.swup.preloadLinks=void 0,this.preloadPromises.clear(),(e=this.mouseEnterDelegate)==null||e.destroy(),(r=this.touchStartDelegate)==null||r.destroy(),(s=this.focusDelegate)==null||s.destroy(),this.stopPreloadingVisibleLinks()}async preload(e,r={}){var s;let o,t;const i=(s=r.priority)!=null&&s;if(Array.isArray(e))return Promise.all(e.map(n=>this.preload(n)));if(e instanceof HTMLAnchorElement)t=e,{href:o}=w.fromElement(e);else{if(typeof e!="string")return;o=e}if(this.preloadPromises.has(o))return this.preloadPromises.get(o);if(!this.shouldPreload(o,{el:t}))return;const d=new Promise(n=>{this.queue.add(()=>{this.performPreload(o).catch(()=>{}).then(h=>n(h)).finally(()=>{this.queue.next(),this.preloadPromises.delete(o)})},i)});return this.preloadPromises.set(o,d),d}preloadLinks(){L(()=>{Array.from(document.querySelectorAll("a[data-swup-preload], [data-swup-preload-all] a")).forEach(e=>this.preload(e))})}preloadLinksOnAttention(){const{swup:e}=this,{linkSelector:r}=e.options,s={passive:!0,capture:!0};this.mouseEnterDelegate=e.delegateEvent(r,"mouseenter",this.onMouseEnter,s),this.touchStartDelegate=e.delegateEvent(r,"touchstart",this.onTouchStart,s),this.focusDelegate=e.delegateEvent(r,"focus",this.onFocus,s)}preloadVisibleLinks(){if(this.preloadObserver)return void this.preloadObserver.update();const{threshold:e,delay:r,containers:s}=this.options.preloadVisibleLinks;this.preloadObserver=function({threshold:o,delay:t,containers:i,callback:d,filter:n}){const h=new Map,p=new IntersectionObserver(a=>{a.forEach(l=>{l.isIntersecting?u(l.target):g(l.target)})},{threshold:o}),u=a=>{var l;const b=(l=h.get(a.href))!=null?l:new Set;h.set(a.href,b),b.add(a),setTimeout(()=>{const m=h.get(a.href);m!=null&&m.size&&(d(a),p.unobserve(a),m.delete(a))},t)},g=a=>{var l;return(l=h.get(a.href))==null?void 0:l.delete(a)},f=()=>{L(()=>{const a=i.map(l=>`${l} a[href]`).join(", ");Array.from(document.querySelectorAll(a)).filter(l=>n(l)).forEach(l=>p.observe(l))})};return{start:()=>f(),stop:()=>p.disconnect(),update:()=>(h.clear(),f())}}({threshold:e,delay:r,containers:s,callback:o=>this.preload(o),filter:o=>!this.options.preloadVisibleLinks.ignore(o)&&this.shouldPreload(o.href,{el:o})}),this.preloadObserver.start()}stopPreloadingVisibleLinks(){this.preloadObserver&&this.preloadObserver.stop()}shouldPreload(e,{el:r}={}){const{url:s,href:o}=w.fromUrl(e);return!(!function(){if(navigator.connection){var t;if(navigator.connection.saveData||(t=navigator.connection.effectiveType)!=null&&t.endsWith("2g"))return!1}return!0}()||this.swup.cache.has(s)||this.preloadPromises.has(s)||this.swup.shouldIgnoreVisit(o,{el:r})||r&&this.swup.resolveUrl(s)===this.swup.resolveUrl(k()))}async performPreload(e){var r=this;return await this.swup.hooks.call("page:preload",void 0,{},async function(s,o){return o.page=await r.swup.fetchPage(e),o.page})}}export{T as default};
//# sourceMappingURL=index.modern.Nfo0UNRS.js.map
